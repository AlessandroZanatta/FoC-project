
\section{Protocol and messages definition}

Legend:
\begin{itemize}
    \item \fcolorbox{black}{lightgreen}{\rule{0pt}{6pt}\rule{6pt}{0pt}}\quad authenticated
    \item \fcolorbox{black}{lightred}{\rule{0pt}{6pt}\rule{6pt}{0pt}}\quad encrypted and authenticated
\end{itemize}

\begin{figure}
    \centering
    \setlength{\instdist}{5cm}
    \setmscoptions
    \begin{msc}{}
        \setmscscale{.8}

        \declinst{client}{}{Client}
        \declinst{server}{}{Server}

        \action*{Knows $p, g, sk_C, pk_C$}{client}
        \action*{\parbox{4.5cm}{\centering
                Knows $p, g, sk_S, pk_S$\\
                $pk_C, CERT_S$}}{server}
        \nextlevel[2]

        \action*{Generates $x$}{client}
        \nextlevel[3]

        \mess{$C, g^x$}{client}{server}
        \nextlevel

        \action*{Generates $y$}{server}
        \nextlevel[3]
        \mess{$S, g^y, CERT_S, \left\{g^x, g^y, C\right\}_{sk_S}$}{server}{client}
        \nextlevel
        \action*{\parbox{4.5cm}{\centering
                Verifies certificate $CERT_S$\\
                Verifies digital signature using $pk_S$ from $CERT_S$\\
                Computes $K = h\left((g^y)^x\right)$
            }}{client}

        \nextlevel[6]
        \mess{$\left\{g^y, g^x, S\right\}_{sk_C}$}{client}{server}
        \nextlevel
        \action*{\parbox{4.5cm}{\centering
                Verifies digital signature and its content\\
                Computes $K = h\left((g^x)^y\right)$
            }}{server}

        \nextlevel[4]
    \end{msc}
    \centering
    \caption{Key agreement protocol with PFS (ISO/IEC IS 9798-3)}
    \label{fig:key_agreement_protocol}
\end{figure}


\begin{figure}
    \centering
    \begin{bytefield}[bitwidth=0.5em]{40}
        \bitheader[]{40, 32, 24, 16, 8, 0} \\
        \bitbox{8}{Type} & \bitbox[lrt]{32}{} \\
        \wordbox[lrb]{2}{Payload (variable length)}
    \end{bytefield}
    \caption{General message format}
\end{figure}

\begin{figure}
    \centering
    \setlength{\instdist}{8.5cm}
    \setmscoptions
    \begin{msc}{}
        \setmscscale{.8}

        \declinst{client}{}{Client}
        \declinst{server}{}{Server}

        \action*{Knows $K, seq$}{client}
        \action*{Knows $K, seq$}{server}

        \nextlevel[2]
        \action*{Requests upload of file $f$}{client}

        \nextlevel[3]

        \mess{$upload, E(f, K), Tag(upload \mid\mid seq, K)$}{client}{server}

        \nextlevel
        \action*{Checks that $f$ can be uploaded}{server}

        \nextlevel[3]
        \mess{$upload\_ans, E(m_1, K), Tag(upload\_ans \mid\mid seq + 1, K)$}{server}{client}

        \nextlevel
        \action*{\parbox{4.5cm}{\centering
                Checks server answer's\\
                If positive, sends file content $fc$}}{client}
        \nextlevel[5]

        \mess{$upload\_chunk, E(fc_0, K), Tag(upload\_chunk \mid\mid seq + 2, K)$}{client}{server}
        \nextlevel[2]
        \mess{$\dots$}{client}{server}
        \nextlevel[2]
        \mess{$upload\_end, E(fc_i, K), Tag(upload\_end \mid\mid seq + 2 + i, K)$}{client}{server}

        \nextlevel[2]
        \action*{\parbox{4.5cm}{\centering
                Sends result to client}}{server}

        \nextlevel[4]
        \mess{$upload\_res, E(m_2, K), Tag(upload\_res \mid\mid seq + 3 + i, K)$}{server}{client}
        \nextlevel
    \end{msc}
    \centering
    \caption{File upload}
    \label{fig:transport_protocol_file_upload}
\end{figure}

\begin{figure}
    \centering
    \setlength{\instdist}{8.5cm}
    \setmscoptions
    \begin{msc}{}
        \setmscscale{.8}

        \declinst{client}{}{Client}
        \declinst{server}{}{Server}

        \action*{Knows $K, seq$}{client}
        \action*{Knows $K, seq$}{server}

        \nextlevel[2]
        \action*{Requests download of file $f$}{client}

        \nextlevel[3]
        \mess{$download, E(f, K), Tag(download \mid\mid seq, K)$}{client}{server}

        \nextlevel
        \action*{\parbox{4.5cm}{\centering
                Checks that $f$ can be downloaded\\
                Sends $f$ content $fc$}}{server}

        \nextlevel[5]
        \mess{$download\_chunk, E(fc_0, K), Tag(download\_chunk \mid\mid seq + 1, K)$}{server}{client}
        \nextlevel[2]
        \mess{$\dots$}{server}{client}
        \nextlevel[2]
        \mess{$download\_end, E(fc_i, K), Tag(download\_end \mid\mid seq + 1 + i, K)$}{server}{client}

        \nextlevel
    \end{msc}
    \centering
    \caption{File download}
    \label{fig:transport_protocol_file_download}
\end{figure}

\begin{figure}
    \centering
    \setlength{\instdist}{8.5cm}
    \setmscoptions
    \begin{msc}{}
        \setmscscale{.8}

        \declinst{client}{}{Client}
        \declinst{server}{}{Server}

        \action*{Knows $K, seq$}{client}
        \action*{Knows $K, seq$}{server}

        \nextlevel[2]
        \action*{Requests deletion of file $f$}{client}

        \nextlevel[3]

        \mess{$delete, E(f, K), Tag(delete \mid\mid seq, K)$}{client}{server}

        \nextlevel
        \action*{\parbox{6cm}{\centering
                Checks that $f$ can be deleted\\
                Prompts user for confirmation}}{server}

        \nextlevel[4]
        \mess{$delete\_conf, E(m_1, K), Tag(delete\_conf \mid\mid seq + 1, K)$}{server}{client}

        \nextlevel
        \action*{Confirms or aborts deletion}{client}
        \nextlevel[5]

        \mess{$delete\_ans, E(dummy, K), Tag(delete\_ans \mid\mid seq + 2, K)$}{client}{server}

        \nextlevel[2]
        \action*{\parbox{4.5cm}{\centering
                Deletes the file\\
                Sends result to client}}{server}

        \nextlevel[4]
        \mess{$delete\_res, E(m_2, K), Tag(delete\_res \mid\mid seq + 3, K)$}{server}{client}
        \nextlevel
    \end{msc}
    \centering
    \caption{File delete}
    \label{fig:transport_protocol_file_delete}
\end{figure}

\begin{figure}
    \centering
    \setlength{\instdist}{8.5cm}
    \setmscoptions
    \begin{msc}{}
        \setmscscale{.8}

        \declinst{client}{}{Client}
        \declinst{server}{}{Server}

        \action*{Knows $K, seq$}{client}
        \action*{Knows $K, seq$}{server}

        \nextlevel[2]
        \action*{Requests listing of files}{client}

        \nextlevel[3]
        \mess{$list, E(dummy, K), Tag(list \mid\mid seq, K)$}{client}{server}

        \nextlevel
        \action*{Gets list of files $fl$}{server}

        \nextlevel[3]
        \mess{$list\_ans, E(fl, K), Tag(list\_ans \mid\mid seq + 1, K)$}{server}{client}

        \nextlevel
    \end{msc}
    \centering
    \caption{File listing}
    \label{fig:transport_protocol_file_listing}
\end{figure}

\begin{figure}
    \centering
    \setlength{\instdist}{8.5cm}
    \setmscoptions
    \begin{msc}{}
        \setmscscale{.8}

        \declinst{client}{}{Client}
        \declinst{server}{}{Server}

        \action*{Knows $K, seq$}{client}
        \action*{Knows $K, seq$}{server}

        \nextlevel[2]
        \action*{\parbox{7cm}{\centering
                Requests rename of file from $f_{old}$ to $f_{new}$ \\
                Let $m_1 = f_{old} \mid\mid f_{new}$}}{client}

        \nextlevel[4]
        \mess{$rename, E(m_1, K), Tag(rename \mid\mid seq, K)$}{client}{server}

        \nextlevel
        \action*{\parbox{7cm}{\centering
                Checks that $f_{old}$ can be renamed to $f_{new}$\\
                Sends result to client
            }}{server}

        \nextlevel[4]
        \mess{$rename\_ans, E(m_2, K), Tag(rename\_ans \mid\mid seq + 1, K)$}{server}{client}

        \nextlevel
    \end{msc}
    \centering
    \caption{File rename}
    \label{fig:transport_protocol_file_rename}
\end{figure}

\begin{figure}
    \centering
    \setlength{\instdist}{8.5cm}
    \setmscoptions
    \begin{msc}{}
        \setmscscale{.8}

        \declinst{client}{}{Client}
        \declinst{server}{}{Server}

        \action*{Knows $K, seq$}{client}
        \action*{Knows $K, seq$}{server}

        \nextlevel[2]
        \action*{Requests graceful logout}{client}

        \nextlevel[3]
        \mess{$logout, E(dummy, K), Tag(logout \mid\mid seq, K)$}{client}{server}

        \nextlevel
        \action*{Gracefully closes current session}{server}

        \nextlevel[3]
        \mess{$logout\_ans, E(dummy, K), Tag(logout\_ans \mid\mid seq + 1, K)$}{server}{client}

        \nextlevel
        \action*{Gracefully closes current session}{client}
        \nextlevel[2]
    \end{msc}
    \centering
    \caption{Log out}
    \label{fig:transport_protocol_log_out}
\end{figure}

\begin{figure}
    \centering
    \begin{bytefield}[bitwidth=0.5em]{40}
        \bitheader[]{40, 32, 24, 16, 8, 0} \\
        \bitbox{8}[bgcolor=lightgreen]{Type} & 
          \bitbox{32}[bgcolor=lightgreen]{Sequence number} \\ 
        \wordbox[lrt]{2}[bgcolor=lightgreen]{IV} \\ 
        \bitbox[lrb]{16}[bgcolor=lightgreen]{} & \bitbox[lrt]{24}[bgcolor=lightred]{} \\
        \wordbox[lrb]{5}[bgcolor=lightred]{Payload (variable length)}
    \end{bytefield}
    \caption{Transport protocol}
\end{figure}
